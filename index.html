<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç’°å¢ƒçŸ¥è­˜å°æ¸¬é©—</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", "Microsoft JhengHei", sans-serif;
      color-scheme: light;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .app {
      width: 100%;
      max-width: 520px;
      margin: 16px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      padding: 20px 18px 24px;
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 4px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .hidden {
      display: none !important;
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 8px 0 12px;
    }
    .level-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    button {
      font-family: inherit;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out,
        background 0.15s ease-out;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-level {
      background: #e5f3ff;
      color: #1d4ed8;
      box-shadow: 0 2px 4px rgba(37,99,235,0.18);
      width: 100%;
    }
    .btn-level:hover {
      background: #dbeafe;
    }
    .btn-main {
      background: #16a34a;
      color: #ffffff;
      box-shadow: 0 3px 7px rgba(22,163,74,0.3);
      width: 100%;
      margin-top: 8px;
    }
    .btn-main:hover {
      background: #15803d;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
      width: 100%;
      margin-top: 6px;
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eff6ff;
      color: #1d4ed8;
      margin-bottom: 8px;
    }
    .badge span {
      margin-left: 4px;
      font-weight: 600;
    }
    .question-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .progress-bar-wrap {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.25s ease-out;
    }
    .question-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
      font-size: 0.98rem;
      line-height: 1.55;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 8px;
    }
    .option-btn {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 9px 11px;
      text-align: left;
      font-size: 0.95rem;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .option-prefix {
      font-weight: 600;
      min-width: 18px;
    }
    .option-btn.correct {
      background: #dcfce7;
      border-color: #16a34a;
    }
    .option-btn.wrong {
      background: #fee2e2;
      border-color: #dc2626;
    }
    .option-btn.disabled {
      opacity: 0.75;
      pointer-events: none;
    }
    .feedback {
      font-size: 0.9rem;
      margin-top: 4px;
      margin-bottom: 4px;
      min-height: 22px;
    }
    .feedback.correct {
      color: #15803d;
    }
    .feedback.wrong {
      color: #b91c1c;
    }
    .explanation-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 2px;
      color: #4b5563;
    }
    .explanation-text {
      font-size: 0.85rem;
      color: #4b5563;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 6px 8px;
      white-space: pre-wrap;
    }
    .result-box {
      text-align: center;
      margin-top: 8px;
    }
    .result-score {
      font-size: 1.6rem;
      font-weight: 700;
      margin: 4px 0;
    }
    .result-detail {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 10px;
    }
    .small-note {
      font-size: 0.78rem;
      color: #9ca3af;
      text-align: center;
      margin-top: 4px;
    }
    @media (min-width: 600px) {
      .app {
        margin-top: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>ç’°å¢ƒçŸ¥è­˜å°æ¸¬é©—</h1>
    <div class="subtitle">é¸æ“‡ç´šåˆ¥ï¼Œæ¯æ¬¡éš¨æ©Ÿå‡º 20 é¡Œï¼Œä¸€é¡Œä¸€é ç«‹å³çœ‹è§£æ</div>

    <!-- èµ·å§‹ç•«é¢ï¼šé¸ç´šåˆ¥ -->
    <section id="start-screen">
      <div class="section-title">è«‹é¸æ“‡ç·´ç¿’ç´šåˆ¥</div>
      <div class="level-grid">
        <button class="btn-level" data-level="åˆç´š">åˆç´š</button>
        <button class="btn-level" data-level="ä¸­ç´š">ä¸­ç´š</button>
        <button class="btn-level" data-level="ä¸­é«˜ç´š">ä¸­é«˜ç´š</button>
        <button class="btn-level" data-level="é«˜ç´š">é«˜ç´š</button>
      </div>
      <p class="small-note">é¡Œç›®ä¾†æºï¼šç’°å¢ƒçŸ¥è­˜ç«¶è³½é¡Œåº«ï¼ˆæ¯æ¬¡ä½œç­”éš¨æ©ŸæŠ½é¡Œï¼‰</p>
    </section>

    <!-- ä½œç­”ç•«é¢ -->
    <section id="quiz-screen" class="hidden">
      <div class="badge">
        ç´šåˆ¥ï¼š<span id="badge-level"></span>
      </div>
      <div class="question-meta">
        <span id="question-counter"></span>
        <span id="score-brief"></span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="progress-bar"></div>
      </div>

      <div class="question-box" id="question-text"></div>

      <div class="options" id="options-container">
        <!-- é¸é …æŒ‰éˆ•æœƒç”± JavaScript å‹•æ…‹ç”¢ç”Ÿ -->
      </div>

      <div id="feedback" class="feedback"></div>
      <div id="explanation-wrap" class="hidden">
        <div class="explanation-title">è§£æ</div>
        <div class="explanation-text" id="explanation-text"></div>
      </div>

      <button id="next-btn" class="btn-main" disabled>ä¸‹ä¸€é¡Œ</button>
      <button id="back-btn" class="btn-secondary">è¿”å›é‡æ–°é¸æ“‡ç´šåˆ¥</button>
    </section>

    <!-- çµæœç•«é¢ -->
    <section id="result-screen" class="hidden">
      <div class="badge">
        æœ¬è¼ªç´šåˆ¥ï¼š<span id="result-level"></span>
      </div>
      <div class="result-box">
        <p>æœ¬æ¬¡å®Œæˆ 20 é¡Œ</p>
        <div class="result-score" id="result-score"></div>
        <div class="result-detail" id="result-detail"></div>
      </div>
      <button id="retry-same-level" class="btn-main">å†åšä¸€è¼ªåŒç´šåˆ¥</button>
      <button id="retry-select-level" class="btn-secondary">å›åˆ°ç´šåˆ¥é¸å–®</button>
      <p class="small-note">æç¤ºï¼šå†æ¬¡ä½œç­”æœƒé‡æ–°éš¨æ©ŸæŠ½é¡Œ</p>
    </section>
  </div>

  <script>
    // ===== å…¨åŸŸç‹€æ…‹ =====
    let allQuestions = [];        // é¡Œåº«å…¨éƒ¨é¡Œç›®
    let currentLevel = null;      // ç›®å‰é¸æ“‡çš„ç´šåˆ¥
    let currentQuestions = [];    // é€™ä¸€è¼ªè¦ä½œç­”çš„ 20 é¡Œ
    let currentIndex = 0;         // ç›®å‰åœ¨ç¬¬å¹¾é¡Œï¼ˆ0-basedï¼‰
    let correctCount = 0;         // ç­”å°é¡Œæ•¸
    let hasAnswered = false;      // ç›®å‰é¡Œç›®æ˜¯å¦å·²ä½œç­”

    // DOM å–å¾—
    const startScreen = document.getElementById("start-screen");
    const quizScreen = document.getElementById("quiz-screen");
    const resultScreen = document.getElementById("result-screen");

    const levelButtons = document.querySelectorAll(".btn-level");
    const badgeLevel = document.getElementById("badge-level");
    const questionCounter = document.getElementById("question-counter");
    const scoreBrief = document.getElementById("score-brief");
    const progressBar = document.getElementById("progress-bar");
    const questionText = document.getElementById("question-text");
    const optionsContainer = document.getElementById("options-container");
    const feedbackEl = document.getElementById("feedback");
    const explanationWrap = document.getElementById("explanation-wrap");
    const explanationText = document.getElementById("explanation-text");
    const nextBtn = document.getElementById("next-btn");
    const backBtn = document.getElementById("back-btn");

    const resultLevel = document.getElementById("result-level");
    const resultScore = document.getElementById("result-score");
    const resultDetail = document.getElementById("result-detail");
    const retrySameLevelBtn = document.getElementById("retry-same-level");
    const retrySelectLevelBtn = document.getElementById("retry-select-level");

    // ===== è®€å– CSV é¡Œåº« =====
    async function loadQuestions() {
      try {
        const res = await fetch("questions.csv?_=" + Date.now());
        if (!res.ok) {
          throw new Error("ç„¡æ³•è¼‰å…¥é¡Œåº«ï¼Œè«‹ç¢ºèª questions.csv æ˜¯å¦èˆ‡ index.html åœ¨åŒä¸€è³‡æ–™å¤¾ã€‚");
        }
        const text = await res.text();
        allQuestions = parseCSVToQuestions(text);
      } catch (err) {
        alert("è¼‰å…¥é¡Œåº«æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n" + err.message);
      }
    }

    // ç°¡æ˜“ CSV è§£æï¼šæ”¯æ´å«å¼•è™Ÿçš„æ¬„ä½
    function parseCSVToQuestions(csvText) {
      const lines = csvText.trim().split(/\r?\n/);
      if (lines.length <= 1) return [];

      const headerLine = lines[0];
      const headers = splitCSVLine(headerLine);

      const idxLevel = headers.indexOf("ç´šåˆ¥");
      const idxQuestion = headers.indexOf("é¡Œç›®");
      const idxOpt1 = headers.indexOf("é¸é …1");
      const idxOpt2 = headers.indexOf("é¸é …2");
      const idxOpt3 = headers.indexOf("é¸é …3");
      const idxOpt4 = headers.indexOf("é¸é …4");
      const idxAnswer = headers.indexOf("ç­”æ¡ˆ");
      const idxExplain = headers.indexOf("è§£æ");

      const result = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const cells = splitCSVLine(line);
        const level = (cells[idxLevel] || "").trim();
        const question = (cells[idxQuestion] || "").trim();
        const opt1 = (cells[idxOpt1] || "").trim();
        const opt2 = (cells[idxOpt2] || "").trim();
        const opt3 = (cells[idxOpt3] || "").trim();
        const opt4 = (cells[idxOpt4] || "").trim();
        const answerRaw = (cells[idxAnswer] || "").trim();
        const explanation = (cells[idxExplain] || "").trim();

        if (!question) continue; // è·³éç©ºåˆ—

        // ä½ çš„ç­”æ¡ˆæ˜¯æ•¸å­—æ ¼å¼ï¼š1 / 2 / 3 / 4
        const ansNum = parseInt(answerRaw, 10);
        const ansIndex = isNaN(ansNum) ? 0 : Math.max(0, Math.min(3, ansNum - 1));

        result.push({
          level,
          question,
          options: [opt1, opt2, opt3, opt4],
          answerIndex: ansIndex,
          explanation
        });
      }

      return result;
    }

    // å°‡ä¸€è¡Œ CSV å­—ä¸²æ‹†æˆé™£åˆ—ï¼ˆè€ƒæ…®å¼•è™Ÿï¼‰
    function splitCSVLine(line) {
      const result = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          // é€£çºŒå…©å€‹ " è¦–ç‚ºä¸€å€‹ "
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === "," && !inQuotes) {
          result.push(current);
          current = "";
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    // ===== é¡Œåº«é‚è¼¯ =====

    function startQuiz(level) {
      currentLevel = level;
      const levelQuestions = allQuestions.filter(q => q.level === level);
      if (levelQuestions.length === 0) {
        alert("ç›®å‰é¡Œåº«ä¸­æ²’æœ‰ã€Œ" + level + "ã€ç´šåˆ¥çš„é¡Œç›®ã€‚");
        return;
      }

      const count = Math.min(20, levelQuestions.length);
      currentQuestions = pickRandomSubset(levelQuestions, count);
      currentIndex = 0;
      correctCount = 0;

      badgeLevel.textContent = level;
      updateScoreBrief();

      startScreen.classList.add("hidden");
      resultScreen.classList.add("hidden");
      quizScreen.classList.remove("hidden");

      showCurrentQuestion();
    }

    function pickRandomSubset(arr, count) {
      const copy = arr.slice();
      // Fisherâ€“Yates æ´—ç‰Œ
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, count);
    }

    function showCurrentQuestion() {
      hasAnswered = false;
      nextBtn.disabled = true;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      explanationWrap.classList.add("hidden");
      explanationText.textContent = "";

      const total = currentQuestions.length;
      const q = currentQuestions[currentIndex];

      questionCounter.textContent = `ç¬¬ ${currentIndex + 1} é¡Œ / å…± ${total} é¡Œ`;
      updateProgress();
      updateScoreBrief();

      questionText.textContent = q.question;

      // å»ºç«‹é¸é …æŒ‰éˆ•
      optionsContainer.innerHTML = "";
      const labels = ["A", "B", "C", "D"];

      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.dataset.index = idx;

        const prefixSpan = document.createElement("span");
        prefixSpan.className = "option-prefix";
        prefixSpan.textContent = labels[idx];

        const textSpan = document.createElement("span");
        textSpan.textContent = opt || "";

        btn.appendChild(prefixSpan);
        btn.appendChild(textSpan);
        btn.addEventListener("click", () => handleAnswer(idx));
        optionsContainer.appendChild(btn);
      });

      // æ›´æ–°ä¸‹ä¸€é¡ŒæŒ‰éˆ•æ–‡å­—
      if (currentIndex === total - 1) {
        nextBtn.textContent = "çœ‹çµæœ";
      } else {
        nextBtn.textContent = "ä¸‹ä¸€é¡Œ";
      }
    }

    function handleAnswer(selectedIndex) {
      if (hasAnswered) return;
      hasAnswered = true;

      const q = currentQuestions[currentIndex];
      const correctIndex = q.answerIndex;

      const optionButtons = optionsContainer.querySelectorAll(".option-btn");
      optionButtons.forEach((btn) => {
        btn.classList.add("disabled");
      });

      const selectedBtn = optionsContainer.querySelector(
        `.option-btn[data-index="${selectedIndex}"]`
      );
      const correctBtn = optionsContainer.querySelector(
        `.option-btn[data-index="${correctIndex}"]`
      );

      if (selectedIndex === correctIndex) {
        correctCount++;
        if (selectedBtn) selectedBtn.classList.add("correct");
        feedbackEl.textContent = "ç­”å°äº†ï¼ğŸ‘";
        feedbackEl.classList.add("correct");
      } else {
        if (selectedBtn) selectedBtn.classList.add("wrong");
        if (correctBtn) correctBtn.classList.add("correct");
        feedbackEl.textContent = "ç­”éŒ¯äº†ï¼Œä¸‹æ¬¡å¯ä»¥å†æ³¨æ„ã€‚";
        feedbackEl.classList.add("wrong");
      }

      // é¡¯ç¤ºè§£æ
      if (q.explanation) {
        explanationWrap.classList.remove("hidden");
        explanationText.textContent = q.explanation;
      }

      updateScoreBrief();
      nextBtn.disabled = false;
    }

    function updateProgress() {
      const total = currentQuestions.length || 1;
      const progress = (currentIndex / total) * 100;
      progressBar.style.width = progress + "%";
    }

    function updateScoreBrief() {
      const totalAnswered = currentIndex;
      if (totalAnswered === 0) {
        scoreBrief.textContent = "å°šæœªç­”é¡Œ";
      } else {
        const rate = Math.round((correctCount / totalAnswered) * 100);
        scoreBrief.textContent = `ç›®å‰ç­”å° ${correctCount} é¡Œï¼ˆ${rate}%ï¼‰`;
      }
    }

    function goNext() {
      if (!hasAnswered) return;
      if (currentIndex >= currentQuestions.length - 1) {
        showResult();
      } else {
        currentIndex++;
        showCurrentQuestion();
      }
    }

    function showResult() {
      quizScreen.classList.add("hidden");
      resultScreen.classList.remove("hidden");

      resultLevel.textContent = currentLevel;

      const total = currentQuestions.length;
      const rate = Math.round((correctCount / total) * 100);

      resultScore.textContent = `${correctCount} / ${total} é¡Œ`;
      resultDetail.textContent = `ç­”å°ç‡ï¼š${rate}%`;
    }

    function backToStart() {
      quizScreen.classList.add("hidden");
      resultScreen.classList.add("hidden");
      startScreen.classList.remove("hidden");
    }

    // ===== äº‹ä»¶ç¶å®š =====
    levelButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const level = btn.dataset.level;
        startQuiz(level);
      });
    });

    nextBtn.addEventListener("click", goNext);
    backBtn.addEventListener("click", backToStart);
    retrySameLevelBtn.addEventListener("click", () => {
      if (currentLevel) {
        startQuiz(currentLevel);
      } else {
        backToStart();
      }
    });
    retrySelectLevelBtn.addEventListener("click", backToStart);

    // è¼‰å…¥é é¢å°±å…ˆæŠŠé¡Œåº«è®€é€²ä¾†
    loadQuestions();
  </script>
</body>
</html>
